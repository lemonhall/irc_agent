# 新闻播报完整工作流

## 环境准备

在 `E:\development\irc_agent\news_viewer` 目录下

所有命令都需要 venv 环境支持：

```powershell
# 在项目根目录激活环境
E:\development\irc_agent\
.\.venv\Scripts\activate

# 进入工作目录
cd news_viewer
```

---

## 🔄 五步工作流

### 1️⃣ 抓取新闻 (fetch_news.py)
```powershell
python fetch_news.py
```
- **输入**: 无
- **输出**: `news.json`
- **功能**: 从新闻源抓取最新新闻数据

---

### 2️⃣ 生成播报脚本 (generate_broadcast.py)
```powershell
python generate_broadcast.py
```
- **输入**: `news.json`
- **输出**: `broadcasts/20251014_073211/broadcast.json`
- **功能**: 
  - 在 `broadcasts/` 下创建时间戳命名的子目录
  - 生成结构化的播报脚本（JSON格式）
  - 包含开场白、新闻条目、结束语等

---

### 3️⃣ 文本转语音 (generate_audio.py)
```powershell
python generate_audio.py
```
- **输入**: `broadcast.json`
- **输出**: 
  - 各板块 MP3 文件（如 `section_1.mp3`、`section_2.mp3`）
  - **完整音频**: `audio_full.mp3`（纯人声版本）
- **功能**: 使用火山引擎 TTS API 将文本转为语音

---

### 4️⃣ 添加背景音乐 (add_bgm.py)
```powershell
python add_bgm.py --volume 0.15
```
- **输入**: 
  - `audio_full.mp3`（人声）
  - `bgm/*.mp3`（背景音乐）
- **输出**: `audio_full_with_bgm.mp3`
- **功能**: 将人声与 BGM 混音，BGM 音量可调节

---

### 5️⃣ 生成视频 (generate_video.py) ⭐ 新功能
```powershell
python generate_video.py
```
- **输入**: 
  - `audio_full_with_bgm.mp3`（或 `audio_full.mp3`）
  - `news_background.jpg`（背景图片，可选）
- **输出**: 
  - `video_full_with_bgm.mp4`（波形图 + 科技风配色）
  - `video_full_with_bgm_1.mp4`（频谱图 + 渐变配色）
- **功能**: 
  - 静态图片 + 音频合成视频
  - 添加音频可视化效果（FFT 频谱/波形）
  - 支持多种颜色方案和位置

**视觉效果**:
- `wave`: 波形图（适合新闻/播客）
- `spectrum`: 频谱柱状图（适合音乐）
- `vectorscope`: 矢量示波器（炫酷效果）
- `none`: 纯静态图片

---

## 🚀 一键运行（推荐）

### Windows PowerShell
```powershell
# 完整流程（包含视频生成）
.\run_workflow.ps1

# 跳过抓新闻（使用现有 news.json）
.\run_workflow.ps1 -SkipFetch

# 只生成视频（跳过前 4 步）
.\run_workflow.ps1 -SkipFetch -SkipBroadcast -SkipAudio -SkipBGM

# 调整 BGM 音量
.\run_workflow.ps1 -BGMVolume 0.2
```

### Linux/Mac
```bash
./run_workflow.sh
```

---

## 📂 输出目录结构

```
broadcasts/
└── 20251014_073211/          # 时间戳命名
    ├── broadcast.json        # 播报脚本（结构化）
    ├── broadcast.txt         # 播报脚本（纯文本）
    ├── section_1.mp3         # 板块1音频
    ├── section_2.mp3         # 板块2音频
    ├── audio_full.mp3        # 完整音频（纯人声）
    ├── audio_full_with_bgm.mp3  # 带BGM音频
    ├── video_full_with_bgm.mp4     # 视频1（波形+科技风）
    └── video_full_with_bgm_1.mp4   # 视频2（频谱+渐变）
```

---

## 🎨 背景图片管理

### 下载背景图片
```powershell
python download_background.py
```

支持主题：
1. 新闻演播室
2. 现代办公室
3. 科技抽象
4. 纯色渐变（本地生成，无需网络）

### 使用自定义图片
- 图片命名: `news_background.jpg`
- 放置位置: `news_viewer/` 目录
- 推荐尺寸: **1280x720** (16:9)

---

## 🔧 高级配置

### 视频生成参数（Python API）
```python
from generate_video import NewsVideoGenerator

generator = NewsVideoGenerator()

generator.generate_video(
    audio_path=Path("audio.mp3"),
    output_path=Path("output.mp4"),
    image_path=Path("background.jpg"),  # 可选
    effect="wave",                       # wave/spectrum/vectorscope/none
    wave_position="bottom",              # top/bottom/center
    color_scheme="tech",                 # default/gradient/blue/gold/tech
    wave_height=200,                     # 波形高度（像素）
    video_quality=23                     # 18=高质量，28=低质量
)
```

### BGM 音量调整
```powershell
python add_bgm.py --volume 0.1   # 安静（10%）
python add_bgm.py --volume 0.15  # 默认（15%）
python add_bgm.py --volume 0.25  # 响亮（25%）
```

---

## 🐛 常见问题

### ❌ "ffmpeg 不可用"
**解决**: 安装 ffmpeg 并添加到 PATH
```powershell
# 检查安装
ffmpeg -version

# 下载: https://ffmpeg.org/download.html
```

### ❌ "背景图片不存在"
**解决**: 运行背景图片下载器
```powershell
python download_background.py
```
或系统会自动使用纯色背景。

### ❌ 音频生成失败
**原因**: 火山引擎 API 密钥未配置
**解决**: 在 `.env` 中设置:
```
VOLCENGINE_APP_ID=your_app_id
VOLCENGINE_ACCESS_TOKEN=your_token
```

---

## 📚 相关文档

- **完整工作流**: `AUTOMATION_GUIDE.md`
- **使用指南**: `USAGE_GUIDE.md`
- **视频生成详解**: `VIDEO_GENERATION_GUIDE.md`
- **BGM 推荐**: `bgm/BGM_RECOMMENDATIONS.md`

---

## 🔮 未来扩展

- [ ] 时间轴图片切换（参考 `timeline_example.py`）
- [ ] 字幕叠加
- [ ] Logo 水印
- [ ] 多语言支持

---

**核心工作流完成！** 🎉

五步流程：**抓新闻 → 生成脚本 → 转语音 → 混BGM → 生成视频**