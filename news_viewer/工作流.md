# 新闻播报完整工作流（支持时间轴多图切换）

## 环境准备

在 `E:\development\irc_agent\news_viewer` 目录下

所有命令都需要 venv 环境支持：

```powershell
# 在项目根目录激活环境
E:\development\irc_agent\
.\.venv\Scripts\activate

# 进入工作目录
cd news_viewer
```

---

## 🔄 完整工作流（6步）

### 1️⃣ 抓取新闻 (fetch_news.py)
```powershell
python fetch_news.py
```
- **输入**: 无
- **输出**: `news.json`
- **功能**: 从新闻源抓取最新新闻数据

---

### 2️⃣ 生成播报脚本 (generate_broadcast.py)
```powershell
python generate_broadcast.py
```
- **输入**: `news.json`
- **输出**: `broadcasts/20251014_073211/broadcast.json`
- **功能**: 
  - 在 `broadcasts/` 下创建时间戳命名的子目录
  - 生成结构化的播报脚本（JSON格式）
  - 包含开场白、新闻条目、结束语等

---

### 3️⃣ 文本转语音 (generate_audio.py)
```powershell
python generate_audio.py
```
- **输入**: `broadcast.json`
- **输出**: 
  - 各板块 MP3 文件（如 `broadcast_00_intro.mp3`、`broadcast_01_world.mp3`）
  - **完整音频**: `broadcast_full.mp3`（纯人声版本）
  - **时间轴信息**: 在 `broadcast.json` 中回写 `start_time` 和 `end_time`
- **功能**: 使用火山引擎 TTS API 将文本转为语音

---

### 4️⃣ 配置图片 (assign_images.py) ⭐ 新功能
```powershell
python assign_images.py
```
- **输入**: 
  - `broadcast.json`（含时间轴信息）
  - Unsplash API（图片搜索）
- **输出**: 
  - `image_01_world.jpg`、`image_02_asia.jpg` 等（自动下载）
  - 更新 `broadcast.json` 中的 `image_file` 字段
- **功能**: 
  - 使用 AI (DeepSeek) 分析新闻内容，生成搜索关键词
  - 从 Unsplash 搜索并下载高质量图片
  - 为每个新闻片段配置不同的背景图片
  - Intro/Outro 可使用固定图片或留空

**配置**:
- 需要在 `.env` 中设置 `UNSPLASH_ACCESS_KEY`
- 可修改 `assign_images.py` 中的 `INTRO_IMAGE` 和 `OUTRO_IMAGE`

---

### 5️⃣ 生成时间轴视频 (generate_video_optimized.py) ⭐ 新功能
```powershell
python generate_video_optimized.py
```
- **输入**: 
  - `broadcast.json`（含时间轴和图片信息）
  - 各片段音频文件（`broadcast_00_intro.mp3` 等）
  - 各片段图片文件（`image_01_world.jpg` 等）
- **输出**: 
  - `temp_video_00.mp4`、`temp_video_01.mp4` 等（临时片段）
  - `video_full_merged.mp4`（拼接后的纯净视频：图片+人声，无特效）
  - `video_full_with_effects.mp4`（添加音频可视化特效）
- **功能**: 
  - **第一步**：为每个片段生成视频（图片+音频），速度很快
  - **第二步**：拼接所有片段，生成完整视频
  - **第三步**：一次性添加音频可视化特效（波形/频谱）
  - 清理临时文件

---

### 6️⃣ 添加背景音乐 (add_bgm.py)
```powershell
python add_bgm.py --volume 0.15
```
- **输入**: 
  - `broadcast_full.mp3`（人声）
  - `bgm/*.mp3`（背景音乐）
- **输出**: `broadcast_full_with_bgm.mp3`
- **功能**: 将人声与 BGM 混音，BGM 音量可调节

**优势**:
- ✅ 每个新闻类别有专属背景图片
- ✅ 图片切换与新闻内容同步
- ✅ 分段生成速度快（图片+音频简单合成）
- ✅ 统一添加特效比逐段处理快得多

---

### 7️⃣ 添加视频BGM (add_bgm_to_video.py) ⭐ 新功能
```powershell
python add_bgm_to_video.py --volume 0.15
```
- **输入**: 
  - `video_full_timeline.mp4`（带特效的视频，纯人声）
  - `bgm/*.mp3`（背景音乐）
- **输出**: 
  - `video_full_timeline_with_bgm.mp4`（最终版本：图片+人声+特效+BGM）
- **功能**: 
  - 混合背景音乐到视频音轨
  - 视频轨道直接复制（速度极快，不重新编码）
  - BGM 自动循环至视频长度

**特点**:
- ⚡ 速度快（视频不重新编码，只处理音频）
- 🎚️ 音量可调（默认 15%）
- 🔁 BGM 自动循环

---

## 🚀 一键运行（推荐）

### Windows PowerShell

#### 方案 A：传统模式（单图背景）
```powershell
# 完整流程
.\run_workflow.ps1

# 跳过图片配置
.\run_workflow.ps1 -SkipImages
```

#### 方案 B：时间轴模式（多图切换）⭐ 推荐
```powershell
# 完整流程（包含图片配置和时间轴视频）
.\run_workflow.ps1 -UseTimeline

# 跳过抓新闻（使用现有 news.json）
.\run_workflow.ps1 -SkipFetch -UseTimeline

# 只重新生成图片和视频部分
.\run_workflow.ps1 -SkipFetch -SkipBroadcast -SkipAudio -UseTimeline

# 调整 BGM 音量
.\run_workflow.ps1 -UseTimeline -BGMVolume 0.2
```

**参数说明**:
- `-SkipFetch`: 跳过新闻抓取
- `-SkipBroadcast`: 跳过播报脚本生成
- `-SkipAudio`: 跳过音频生成
- `-SkipImages`: 跳过图片配置（使用纯色背景）
- `-SkipBGM`: 跳过音频BGM（仅生成纯人声音频）
- `-SkipVideo`: 跳过视频生成
- `-UseTimeline`: 使用时间轴视频生成器（多图切换）
- `-BGMVolume`: 设置BGM音量（0.0-1.0，默认0.15）

# 只生成视频（跳过前 4 步）
.\run_workflow.ps1 -SkipFetch -SkipBroadcast -SkipAudio -SkipBGM

# 调整 BGM 音量
.\run_workflow.ps1 -BGMVolume 0.2
```

### Linux/Mac
```bash
./run_workflow.sh
```

---

## 📂 输出目录结构

### 传统模式（单图背景）
```
broadcasts/
└── 20251014_073211/          # 时间戳命名
    ├── broadcast.json        # 播报脚本（结构化，含时间轴）
    ├── broadcast.txt         # 播报脚本（纯文本）
    ├── broadcast_00_intro.mp3      # 开场白音频
    ├── broadcast_01_world.mp3      # 世界新闻音频
    ├── broadcast_02_asia.mp3       # 亚太新闻音频
    ├── ...
    ├── broadcast_full.mp3          # 完整音频（纯人声）
    ├── broadcast_full_with_bgm.mp3 # 带BGM音频
    └── video_full_with_bgm.mp4     # 视频（单图背景）
```

### 时间轴模式（多图切换）⭐ 推荐
```
broadcasts/
└── 20251014_081240/          # 时间戳命名
    ├── broadcast.json        # 播报脚本（结构化，含时间轴和图片路径）
    ├── broadcast.txt         # 播报脚本（纯文本）
    │
    ├── broadcast_00_intro.mp3      # 开场白音频
    ├── broadcast_01_world.mp3      # 世界新闻音频
    ├── broadcast_02_asia.mp3       # 亚太新闻音频
    ├── ...
    ├── broadcast_full.mp3          # 完整音频（纯人声）
    ├── broadcast_full_with_bgm.mp3 # 带BGM音频
    │
    ├── intro_background.jpg        # 固定图片（可选）
    ├── image_01_world.jpg          # 世界新闻图片
    ├── image_02_asia.jpg           # 亚太新闻图片
    ├── image_03_americas.jpg       # 美洲新闻图片
    ├── ...
    │
    ├── temp_video_00.mp4           # 临时片段（生成后自动删除）
    ├── temp_video_01.mp4           # 临时片段（生成后自动删除）
    ├── ...
    │
    ├── video_full_merged.mp4       # 合并后的视频（图片+人声，无特效）
    ├── video_full_with_effects.mp4 # 添加特效后的视频（图片+人声+波形）
    └── video_full_with_effects_with_bgm.mp4  # 最终版本（图片+人声+波形+BGM）
```

---

## 🎨 背景图片管理

### 下载背景图片
```powershell
python download_background.py
```

支持主题：
1. 新闻演播室
2. 现代办公室
3. 科技抽象
4. 纯色渐变（本地生成，无需网络）

### 使用自定义图片
- 图片命名: `news_background.jpg`
- 放置位置: `news_viewer/` 目录
- 推荐尺寸: **1280x720** (16:9)

---

## 🔧 高级配置

### 视频生成参数（Python API）
```python
from generate_video import NewsVideoGenerator

generator = NewsVideoGenerator()

generator.generate_video(
    audio_path=Path("audio.mp3"),
    output_path=Path("output.mp4"),
    image_path=Path("background.jpg"),  # 可选
    effect="wave",                       # wave/spectrum/vectorscope/none
    wave_position="bottom",              # top/bottom/center
    color_scheme="tech",                 # default/gradient/blue/gold/tech
    wave_height=200,                     # 波形高度（像素）
    video_quality=23                     # 18=高质量，28=低质量
)
```

### BGM 音量调整
```powershell
python add_bgm.py --volume 0.1   # 安静（10%）
python add_bgm.py --volume 0.15  # 默认（15%）
python add_bgm.py --volume 0.25  # 响亮（25%）
```

---

## 🐛 常见问题

### ❌ "ffmpeg 不可用"
**解决**: 安装 ffmpeg 并添加到 PATH
```powershell
# 检查安装
ffmpeg -version

# 下载: https://ffmpeg.org/download.html
```

### ❌ "背景图片不存在"
**解决**: 运行背景图片下载器
```powershell
python download_background.py
```
或系统会自动使用纯色背景。

### ❌ 音频生成失败
**原因**: 火山引擎 API 密钥未配置
**解决**: 在 `.env` 中设置:
```
VOLCENGINE_APP_ID=your_app_id
VOLCENGINE_ACCESS_TOKEN=your_token
```

---

## 📚 相关文档

- **完整工作流**: `AUTOMATION_GUIDE.md`
- **使用指南**: `USAGE_GUIDE.md`
- **视频生成详解**: `VIDEO_GENERATION_GUIDE.md`
- **BGM 推荐**: `bgm/BGM_RECOMMENDATIONS.md`

---

## 🔮 未来扩展

- [ ] 时间轴图片切换（参考 `timeline_example.py`）
- [ ] 字幕叠加
- [ ] Logo 水印
- [ ] 多语言支持

---

**核心工作流完成！** 🎉

五步流程：**抓新闻 → 生成脚本 → 转语音 → 混BGM → 生成视频**